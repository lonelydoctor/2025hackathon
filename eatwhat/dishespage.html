<!DOCTYPE html>
<html>
<head>
  <title>èœå“æ¨è</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: url('./images/dishes-2.jpeg') center/cover;
      position: relative;
    }
    body::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(216, 163, 65, 0.704);
      z-index: 1;
    }
    .content {
      position: relative;
      z-index: 2;
      padding: 2rem;
    }
    h1 {
      color: white;
      text-align: center;
      font-size: 3rem;
    }
    #camera {
      width: 640px;
      height: 480px;
      background: black;
      margin: 2rem auto;
    }
    #capture-btn {
      display: block;
      margin: 1rem auto;
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .result-container {
      display: flex;
      gap: 2rem;
      padding: 2rem;
    }
    #preview {
      width: 100%;
       height: 100%;
    }
    .photo-preview {
      flex: 1;
      min-height: 300px;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    <style>
      .camera-error {
        padding: 20px;
        background: rgba(255,0,0,0.1);
        border: 2px solid red;
        color: darkred;
      }
      
      .camera-error button {
        margin-top: 10px;
        padding: 8px 16px;
        background: #ff4444;
        color: white;
      }
    </style>
  </style>
</head>
<body>
  <div class="content">
    <h1>èœå“æ¨è</h1>
    <div id="camera">
      <video id="preview" autoplay muted playsinline></video>
    </div>
    <button id="capture-btn">ğŸ“·ç‚¹å‡»æ‹ç…§</button>
  </div>

  <script>
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const resultImage = document.getElementById('result-image');
        const faceResult = document.getElementById('face-result');
        const videoContainer = document.getElementById('video-container');
        let mediaStream = null;
  // åœ¨DOMåŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ
window.addEventListener('DOMContentLoaded', async () => {
    const video = document.getElementById('preview');
    if (!video) return;

    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'environment'
            }
        });
        
        video.srcObject = mediaStream;
        video.onloadedmetadata = () => {
            video.play();
            document.getElementById('camera').style.display = 'block';
            document.getElementById('capture').disabled = false;
        };

        // æ·»åŠ æ‘„åƒå¤´çŠ¶æ€ç›‘å¬
        mediaStream.getVideoTracks()[0].addEventListener('ended', () => {
            showError('æ‘„åƒå¤´è¿æ¥æ„å¤–ä¸­æ–­');
        });

    } catch (err) {
        showError('è¯·å…è®¸æ‘„åƒå¤´è®¿é—®æƒé™');
        console.error('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', err);
    }
});

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'camera-error';
    errorDiv.innerHTML = `
        <h3>âš ï¸ æ‘„åƒå¤´å¼‚å¸¸</h3>
        <p>${message}</p>
        <button onclick="initCamera()">æ‰‹åŠ¨é‡è¯•</button>
    `;
    document.querySelector('.content').prepend(errorDiv);
}
     // è°ƒç”¨Face++äººè„¸æ£€æµ‹API
     async function detectFaces(imageBlob) {
            const formData = new FormData();
            formData.append('api_key', 'mSptsjK7hxWAuKyOGmTjQAhYwJ2MaCJJ'); 
            formData.append('api_secret', 'vcBaU1AknR9S_NgPnc8oZGrEn-H-_NOk');
            formData.append('image_file', imageBlob, 'photo.jpg');
            formData.append('return_landmark', '0');
            formData.append('return_attributes', 'gender,age,smiling,emotion,skinstatus,beauty');

            try {
                const response = await fetch('https://api-cn.faceplusplus.com/facepp/v3/detect', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                return null;
            }
        }
    // æ‹ç…§åŠŸèƒ½
    // æ¸²æŸ“æ£€æµ‹ç»“æœï¼ˆé‡ç‚¹ä¿®æ”¹éƒ¨åˆ†ï¼‰
    function renderResults(data) {
            // å®šä¹‰æƒ…ç»ªå­—æ®µçš„ä¸­æ–‡æ˜ å°„
            const emotionLabels = {
                anger: 'æ„¤æ€’',
                disgust: 'åŒæ¶',
                fear: 'ææƒ§',
                happiness: 'é«˜å…´',
                neutral: 'å¹³é™',
                sadness: 'ä¼¤å¿ƒ',
                surprise: 'æƒŠè®¶'
            };
    
      // æ–°å¢çš®è‚¤çŠ¶æ€å­—æ®µçš„ä¸­æ–‡æ˜ å°„
      const skinstatusLabels = {
        health: 'å¥åº·',
        stain: 'è‰²æ–‘',
        acne: 'é’æ˜¥ç—˜',
        dark_circle: 'é»‘çœ¼åœˆ'
      };
    
      let html = '<h3>äººè„¸æ£€æµ‹ç»“æœ</h3>';
      if (data && data.faces && data.faces.length > 0) {
        data.faces.forEach((face, index) => {
          html += `
          <div class="result-item">äººè„¸${index + 1}ï¼š</div>
          <div class="result-item">æ€§åˆ«ï¼š${face.attributes.gender?.value || 'æœªçŸ¥'}</div>
          <div class="result-item">å¹´é¾„ï¼š${face.attributes.age?.value || 'æœªçŸ¥'}</div>
          ${face.attributes.beauty ? `
              <div class="result-item">é¢œå€¼è¯„åˆ†ï¼š</div>
              <div class="sub-result">ç”·æ€§è¯„åˆ†ï¼š${face.attributes.beauty.male_score.toFixed(3)}</div>
              <div class="sub-result">å¥³æ€§è¯„åˆ†ï¼š${face.attributes.beauty.female_score.toFixed(3)}</div>
          ` : ''}
          <div class="result-item">å¾®ç¬‘åº¦ï¼š${face.attributes.smile?.value ? face.attributes.smile.value.toFixed(2) : 'æœªçŸ¥'}%</div>
          `;
    
          // å¤„ç†emotionï¼ˆæƒ…ç»ªï¼‰
          if (face.attributes.emotion) {
            html += '<div class="result-item">æƒ…ç»ªåˆ†å¸ƒï¼š</div>';
            Object.entries(face.attributes.emotion).forEach(([key, value]) => {
              const label = emotionLabels[key] || key;
              // æ–°å¢ç±»å‹æ£€æŸ¥ï¼Œé¿å…undefinedè°ƒç”¨toFixed
              const safeValue = typeof value === 'number' ? value : 0;
              html += `<div class="sub-result">${label}ï¼š${safeValue.toFixed(3)}</div>`;
            });
          }
    
          // å¤„ç†skinstatusï¼ˆçš®è‚¤çŠ¶æ€ï¼‰
          if (face.attributes.skinstatus) {
            html += '<div class="result-item">çš®è‚¤çŠ¶æ€ï¼š</div>';
            Object.entries(face.attributes.skinstatus).forEach(([key, value]) => {
              const label = skinstatusLabels[key] || key;
              // æ–°å¢ç±»å‹æ£€æŸ¥ï¼Œé¿å…undefinedè°ƒç”¨toFixed
              const safeValue = typeof value === 'number' ? value : 0;
              html += `<div class="sub-result">${label}ï¼š${safeValue.toFixed(3)}</div>`;
            });
          }
        });
      } else {
        html += '<div class="result-item">æœªæ£€æµ‹åˆ°äººè„¸</div>';
      } // æ·»åŠ ç¼ºå¤±çš„é—­åˆå¤§æ‹¬å·
      
      faceResult.innerHTML = html;
      faceResult.style.display = 'block';
    }
    // æ‹ç…§é€»è¾‘
    captureBtn.addEventListener('click', async () => {
            if (!mediaStream) {
                await initCamera();
            } else {
                // ç”Ÿæˆå›¾ç‰‡Blob
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg');
                const response = await fetch(imageData);
                const imageBlob = await response.blob();

                // æ˜¾ç¤ºå›¾ç‰‡
                resultImage.src = imageData;
                resultImage.style.display = 'block';
                stopCamera();
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'inline-block';

                // è°ƒç”¨APIå¹¶æ¸²æŸ“ç»“æœ
                const detectData = await detectFaces(imageBlob);
                if (detectData) renderResults(detectData);

                }
        });

  </script>
</body>
</html>


