<!DOCTYPE html>
<html>
<head>
  <title>èœå“æ¨è</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: url('./images/dishes-2.jpeg') center/cover;
      position: relative;
    }
    body::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(216, 163, 65, 0.704);
      z-index: 1;
    }
    .content {
      position: relative;
      z-index: 2;
      padding: 2rem;
    }
    h1 {
      color: white;
      text-align: center;
      font-size: 3rem;
    }
    #camera {
      width: 640px;
      height: 480px;
      background: black;
      margin: 2rem auto;
    }
    #capture-btn {
      display: block;
      margin: 1rem auto;
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #result-image {
      display: none;
      max-width: 100%;
      margin: 1rem auto;
    }
    #face-result {
      display: none;
      color: white;
      margin-top: 1rem;
    }
    #retake-btn {
      display: none;
      margin: 1rem auto;
      padding: 12px 24px;
      background: #ff9800;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .result-container {
      display: flex;
      gap: 2rem;
      padding: 2rem;
    }
    #preview {
      width: 100%;
       height: 100%;
    }
    .photo-preview {
      flex: 1;
      min-height: 300px;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    .survey-wrapper {
      color: white;
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 1rem;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .survey-wrapper input {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .optional-note {
      text-align: center;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    <style>
      .camera-error {
        padding: 20px;
        background: rgba(255,0,0,0.1);
        border: 2px solid red;
        color: darkred;
      }
      
      .camera-error button {
        margin-top: 10px;
        padding: 8px 16px;
        background: #ff4444;
        color: white;
      }
    </style>
  </style>
</head>
<body>
  <div class="content">
    <h1>èœå“æ¨è</h1>
    <div class="survey-wrapper">
      <div class="optional-note">ä»¥ä¸‹ä¿¡æ¯å‡ä¸º<span style="color:#ffd">é€‰å¡«</span></div>
      <form id="survey-form" style="margin-bottom:1rem;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">
      <input id="height_cm" placeholder="èº«é«˜(cm)" style="width:120px;">
      <input id="weight_kg" placeholder="ä½“é‡(kg)" style="width:120px;">
      <input id="birthday" placeholder="ç”Ÿæ—¥ YYYY-MM-DD" style="width:160px;">
      <input id="taste_preference" placeholder="å£å‘³åå¥½" style="width:160px;">
      <input id="health_goal" placeholder="å¥åº·ç›®æ ‡" style="width:160px;">
      <input id="food_restrictions" placeholder="å¿Œå£" style="width:160px;">
      <input id="self_reported_mood" placeholder="ä»Šæ—¥å¿ƒæƒ…" style="width:160px;">
      <input id="activity_level" placeholder="æ´»åŠ¨é‡" style="width:120px;">
      <input id="blood_type" placeholder="è¡€å‹" style="width:120px;">
      <input id="recent_focus" placeholder="è¿‘æœŸå…³æ³¨" style="width:160px;">
      <input id="enhance_or_dissolve" placeholder="æƒ³æå‡/åŒ–è§£" style="width:160px;">
      </form>
    </div>
    <div id="camera">
      <video id="preview" autoplay muted playsinline></video>
    </div>
    <button id="capture-btn">ğŸ“·ç‚¹å‡»æ‹ç…§</button>
    <img id="result-image">
    <div id="face-result"></div>
    <pre id="recommendation-output" style="display:none;color:white;white-space:pre-wrap;margin-top:1rem;"></pre>
    <button id="retake-btn">é‡æ–°æ‹ç…§</button>
  </div>

  <script>
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const resultImage = document.getElementById('result-image');
        const faceResult = document.getElementById('face-result');
        const recommendationOutput = document.getElementById('recommendation-output');
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById("preview");
        let mediaStream = null;
window.addEventListener("DOMContentLoaded", () => { loadUserInfo(); initCamera(); });

async function initCamera() {
    if (!video) return;
    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: "environment" }
        });
        video.srcObject = mediaStream;
        video.onloadedmetadata = async () => {
            await video.play();
            document.getElementById("camera").style.display = "block";
            captureBtn.disabled = false;
        };
        mediaStream.getVideoTracks()[0].addEventListener("ended", () => {
            showError("æ‘„åƒå¤´è¿æ¥æ„å¤–ä¸­æ–­");
        });
    } catch (err) {
        showError("è¯·å…è®¸æ‘„åƒå¤´è®¿é—®æƒé™");
        console.error("æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:", err);
    }
}

function stopCamera() {
    if (mediaStream) {
        mediaStream.getTracks()[0].stop();
        mediaStream = null;
    }
}


function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'camera-error';
    errorDiv.innerHTML = `
        <h3>âš ï¸ æ‘„åƒå¤´å¼‚å¸¸</h3>
        <p>${message}</p>
        <button onclick="initCamera()">æ‰‹åŠ¨é‡è¯•</button>
    `;
    document.querySelector('.content').prepend(errorDiv);
}
     // è°ƒç”¨Face++äººè„¸æ£€æµ‹API
        async function detectFaces(imageBlob) {
            const formData = new FormData();
            formData.append('api_key', 'mSptsjK7hxWAuKyOGmTjQAhYwJ2MaCJJ'); 
            formData.append('api_secret', 'vcBaU1AknR9S_NgPnc8oZGrEn-H-_NOk');
            formData.append('image_file', imageBlob, 'photo.jpg');
            formData.append('return_landmark', '0');
            formData.append('return_attributes', 'gender,age,smiling,emotion,skinstatus,beauty');

            try {
                const response = await fetch('https://api-cn.faceplusplus.com/facepp/v3/detect', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                return null;
            }
        }

        function loadUserInfo() {
            const data = localStorage.getItem('userInfo');
            if (!data) return;
            try {
                const info = JSON.parse(data);
                Object.keys(info).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = info[key];
                });
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', e);
            }
        }

        function getUserInfo() {
            return {
                height_cm: document.getElementById('height_cm').value || '',
                weight_kg: document.getElementById('weight_kg').value || '',
                birthday: document.getElementById('birthday').value || '',
                taste_preference: document.getElementById('taste_preference').value || '',
                health_goal: document.getElementById('health_goal').value || '',
                food_restrictions: document.getElementById('food_restrictions').value || '',
                self_reported_mood: document.getElementById('self_reported_mood').value || '',
                activity_level: document.getElementById('activity_level').value || '',
                blood_type: document.getElementById('blood_type').value || '',
                recent_focus: document.getElementById('recent_focus').value || '',
                enhance_or_dissolve: document.getElementById('enhance_or_dissolve').value || ''
            };
        }

        const PROMPT_TEMPLATE = `ä½ æ˜¯ã€ŒAIé¢ç›¸ç„å­¦è¥å…»æ¨èå¸ˆã€ï¼Œèåˆé¢éƒ¨è¯†åˆ«ç»“æœã€ç”¨æˆ·å¡«å†™é—®å·ä¿¡æ¯ã€ç°ä»£è¥å…»ç§‘å­¦ä¸ä¸œæ–¹ç„å­¦ï¼Œä¸ºCç«¯ç”¨æˆ·ç”Ÿæˆè¶£å‘³ã€ç²¾å‡†ã€ä¸ªæ€§åŒ–çš„åˆé¤æ¨èå»ºè®®ã€‚

ä½ çš„ä»»åŠ¡ï¼š
- è¾“å…¥æ•°æ®ï¼šé¢éƒ¨è¯†åˆ«æ•°æ®ï¼ˆå¿…å¡«ï¼‰+ ç”¨æˆ·é—®å·ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰
- è¾“å‡ºä¸¥æ ¼ç»“æ„åŒ–çš„JSONæ ¼å¼ï¼Œä¾›å‰ç«¯ç³»ç»Ÿè§£æå±•ç¤ºï¼›
- å†…å®¹é€»è¾‘ç»“åˆé¢éƒ¨å›¾åƒåˆ†æä¸ç”¨æˆ·ä¸ªæ€§åŒ–å¡«å†™ä¿¡æ¯ï¼›
- ä¿æŒåˆ›é€ æ€§è¡¨è¾¾ï¼Œé¿å…æ¨¡æ¿é‡å¤ï¼Œç¡®ä¿æ¯æ—¥è¾“å‡ºæœ‰æ–°é²œæ„Ÿã€ç¤¾äº¤ä¼ æ’­æ€§å’Œå¨±ä¹ä½“éªŒã€‚
---

ã€è¾“å…¥æ•°æ®ã€‘

### å¿…å¡«è¾“å…¥ï¼ˆé¢éƒ¨è¯†åˆ«æ¥å£æä¾›ï¼Œå§‹ç»ˆå­˜åœ¨ï¼‰

json
[FACE_INPUT]

é€‰å¡«è¾“å…¥ï¼ˆç”¨æˆ·é—®å·ä¿¡æ¯ï¼Œéƒ¨åˆ†æˆ–å…¨éƒ¨å¯èƒ½ç¼ºçœï¼‰
[USER_INPUT]

ä½ éœ€è¦ç»“åˆå¿…å¡«çš„é¢éƒ¨è¯†åˆ«ç»“æœï¼Œä¸é€‰å¡«çš„ç”¨æˆ·ä¿¡æ¯é—®å·ï¼Œæ•´åˆç”Ÿæˆé¥®é£Ÿæ¨èç»“æœã€‚é€‰å¡«é—®å·ä¿¡æ¯å¦‚æœç¼ºå¤±ï¼Œå¯ä»…åŸºäºé¢éƒ¨è¯†åˆ«æ•°æ®ç‹¬ç«‹å®Œæˆç”Ÿæˆï¼›åŸåˆ™å¦‚ä¸‹ï¼š

å¡«å†™çš„ä¿¡æ¯è¶Šå¤šï¼Œå†…å®¹åº”ä½“ç°è¶Šä¸°å¯Œä¸ªæ€§åŒ–ï¼›

é€»è¾‘ä¸°å¯Œï¼Œä½†è¾“å‡ºéœ€çµæ´»å¤šæ ·ï¼Œä¸å¾—å›ºå®šæ¨¡æ¿æ­»æ¿è¾“å‡ºï¼›

ä¿ç•™å……åˆ†åˆ›é€ ç©ºé—´ï¼Œä½“ç°AIçš„åˆ›é€ åŠ›ä¸å¨±ä¹æ€§ã€‚

ä¸€ã€å„å­—æ®µç”Ÿæˆè¯´æ˜
1. metaphysicsï¼ˆç„å­¦ä¿¡æ¯ï¼‰
lucky_colorï¼šç»¼åˆé¢éƒ¨çŠ¶æ€ã€æƒ…ç»ªè¡¨ç°ã€è¿‘æœŸå…³æ³¨æ–¹å‘ã€è¡€å‹ç­‰è‡ªç”±å‘æŒ¥ï¼Œå‚è€ƒäº”è¡Œè‰²ç³»ï¼ˆé‡‘ç™½é“¶ã€æœ¨é’ç»¿ã€æ°´é»‘è“ã€ç«çº¢æ©™ç´«ã€åœŸé»„æ£•ï¼‰ã€‚

lucky_numberï¼šç»“åˆå¹´é¾„ã€æƒ…ç»ªã€å¥åº·ç›®æ ‡ã€ç„å­¦è¯‰æ±‚ç­‰ç”Ÿæˆæœ‰ç§¯æå¯“æ„çš„å¹¸è¿æ•°å­—ï¼ˆ1-9ï¼‰ã€‚

guardian_starï¼šç»“åˆç”Ÿæ—¥ã€è¡€å‹ã€ç„å­¦è¯‰æ±‚ï¼Œè‡ªç”±è®¾å®šä¸œæ–¹ç„å­¦æˆ–è¶£å‘³å®ˆæŠ¤æ˜Ÿï¼ˆå¦‚ï¼šç´«å¾®ã€æ–‡æ˜Œã€å¤©å–œã€ç¦å¾·ã€æ‹›è´¢çŒ«ç­‰ï¼‰ã€‚

five_elements_foodï¼šç”Ÿæˆä»Šæ—¥å®œé£Ÿäº”è¡Œæ­é…æè¿°ï¼ˆå¦‚ï¼šæ°´æœ¨åŒä¿® æ¸…ç«å…»é¢œï¼‰ã€‚

today_yi / today_jiï¼šé¥®é£Ÿä¸æƒ…ç»ªä¸Šçš„å®œå¿Œæç¤ºï¼Œè¯­è¨€å¯å¹½é»˜è½»æ¾ã€‚

2. face_summaryï¼ˆé¢ç›¸ç„å­¦è§£è¯»ï¼‰
èåˆé¢éƒ¨çš®è‚¤æŒ‡æ ‡ã€å¾®ç¬‘åº¦ã€æ°”åœºç”Ÿæˆè¶£å‘³é¢ç›¸è§£è¯»è¯­ã€‚

3. mood_summaryï¼ˆå¿ƒæƒ…è§£è¯»ï¼‰
ç»¼åˆé¢éƒ¨æƒ…ç»ªä¸è‡ªå¡«ä»Šæ—¥å¿ƒæƒ…è‡ªç”±ç”Ÿæˆï¼Œè¯­è¨€äº²åˆ‡è½»æ¾ã€‚

4. recommendationsï¼ˆèœå“æ¨èï¼‰
æ¯æ¬¡è¾“å‡º 4 é“èœå“ï¼Œæ¯é“èœå“åŒ…å«ï¼š

dishï¼šå…·ä½“èœå“åç§°ï¼›

fun_commentï¼šè½»æ¾å¹½é»˜ä¿çš®çš„è¶£å‘³æ–‡æ¡ˆï¼Œå¯æŠ¼éŸµå¯åŠ emojiï¼›

metaphysics_reasonï¼šç„å­¦èƒŒä¹¦é€»è¾‘ï¼›

nutrition_valueï¼šé€šä¿—è¥å…»äº®ç‚¹ï¼›

seasonal_reasonï¼šèŠ‚æ°”æˆ–æ—¶ä»¤åˆç†æ€§ã€‚

èœå“é€»è¾‘åˆ†å¸ƒï¼š

ç¬¬ä¸€èœï¼šå¹¸è¿è‰²å‘¼åº”é£Ÿæï¼›

ç¬¬äºŒèœï¼šé¢éƒ¨çš®è‚¤è°ƒç†é£Ÿæï¼›

ç¬¬ä¸‰èœï¼šå¥åº·ç›®æ ‡&æƒ…ç»ªç–—æ„ˆé£Ÿæï¼›

ç¬¬å››èœï¼šèŠ‚æ°”æ—¶ä»¤é£Ÿæã€‚

éœ€æ³¨æ„ï¼š

é£Ÿæéœ€ç¬¦åˆç”¨æˆ·å¿Œå£é™åˆ¶ï¼›

å……åˆ†ä½“ç°å¥åº·ç›®æ ‡ï¼ˆå¦‚å‡è„‚â†’æ§æ²¹é«˜è›‹ç™½ï¼Œå¢è‚Œâ†’è¡¥è›‹ç™½ï¼ŒæŠ¤èƒƒâ†’è½¯çƒ‚æ¸…æ·¡ï¼‰ï¼›

ç»“åˆæ´»åŠ¨é‡ä¸å½“å‰èƒ½é‡ä»£è°¢éœ€æ±‚åŒ¹é…æ¨èã€‚

5. personalized_insightï¼ˆä¸ªäººä¸“å±é”¦å›Šï¼‰
health_tipï¼šä¸ªæ€§åŒ–å¥åº·å»ºè®®ï¼›

energy_tipï¼šæ°”åœºèƒ½é‡æé†’ï¼›

fortune_tipï¼šè¿åŠ¿ç„å­¦é”¦å›Šã€‚

6ï¸. closing_quoteï¼ˆç»“å°¾ç¥ç¦ï¼‰
ä¸€å¥é€‚åˆç¤¾äº¤åˆ†äº«çš„è½»æ¾ç»“è¯­ã€‚

ã€ç‰¹åˆ«æé†’ã€‘

é™¤ JSON ç»“æ„ä¹‹å¤–ä¸¥ç¦è¾“å‡ºä»»ä½•å¤šä½™æ–‡å­—ï¼›

ä¿è¯è¾“å‡ºå†…å®¹æ¯æ—¥æœ‰æ–°é²œæ„Ÿï¼Œé¿å…æ¨¡æ¿å¥—è·¯å¼ç»“æœï¼›

é£æ ¼æ•´ä½“ä¿æŒå¹´è½»åŒ–ã€è¶£å‘³ç„å­¦ã€æ­£èƒ½é‡ã€ç¤¾äº¤ä¼ æ’­æ„Ÿæå¼ºã€‚

ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘

è¯·ä¸¥æ ¼æŒ‰ç…§å¦‚ä¸‹ç»“æ„åŒ–JSONæ ¼å¼è¾“å‡ºï¼Œå­—æ®µé¡ºåºã€å±‚çº§ã€å‘½åå¿…é¡»ä¸€è‡´ã€‚é™¤JSONä¹‹å¤–ä¸å¾—è¾“å‡ºä»»ä½•å…¶ä»–æ–‡å­—ã€‚

{
  "metaphysics": {
    "lucky_color": "",
    "lucky_number": "",
    "guardian_star": "",
    "five_elements_food": "",
    "today_yi": "",
    "today_ji": ""
  },
  "face_summary": "",
  "mood_summary": "",
  "recommendations": [
    {
      "dish": "",
      "fun_comment": "",
      "metaphysics_reason": "",
      "nutrition_value": "",
      "seasonal_reason": ""
    },
    {
      "dish": "",
      "fun_comment": "",
      "metaphysics_reason": "",
      "nutrition_value": "",
      "seasonal_reason": ""
    },
    {
      "dish": "",
      "fun_comment": "",
      "metaphysics_reason": "",
      "nutrition_value": "",
      "seasonal_reason": ""
    },
    {
      "dish": "",
      "fun_comment": "",
      "metaphysics_reason": "",
      "nutrition_value": "",
      "seasonal_reason": ""
    }
  ],
  "personalized_insight": {
    "health_tip": "",
    "energy_tip": "",
    "fortune_tip": ""
  },
  "closing_quote": "",
  "disclaimer": "AIé£Ÿç–—å»ºè®®ï¼Œä»…ä¾›å¨±ä¹å‚è€ƒ"
}`;

        function buildPrompt(face, user) {
            return PROMPT_TEMPLATE
                .replace('[FACE_INPUT]', JSON.stringify(face, null, 2))
                .replace('[USER_INPUT]', JSON.stringify(user, null, 2));
        }

        async function callGPT(prompt) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer YOUR_OPENAI_API_KEY'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7
                    })
                });
                const data = await response.json();
                return data.choices && data.choices[0].message.content;
            } catch (e) {
                console.error('GPTè°ƒç”¨å¤±è´¥', e);
                return null;
            }
        }

        function displayRecommendations(text) {
            if (!text) return;
            recommendationOutput.style.display = 'block';
            try {
                const obj = JSON.parse(text);
                recommendationOutput.textContent = JSON.stringify(obj, null, 2);
            } catch (e) {
                recommendationOutput.textContent = text;
            }
        }

       async function processFaceData(data) {
            if (!data || !data.faces || !data.faces.length) {
                faceResult.style.display = 'block';
                faceResult.textContent = 'æœªæ£€æµ‹åˆ°äººè„¸';
                return;
            }
            faceResult.style.display = 'none';

            const attr = data.faces[0].attributes || {};
            const faceInfo = {
                gender: attr.gender ? attr.gender.value : '',
                age: attr.age ? attr.age.value : '',
                smile_score: attr.smile ? attr.smile.value : '',
                emotions: {
                    happy: attr.emotion ? attr.emotion.happiness : '',
                    calm: attr.emotion ? attr.emotion.neutral : '',
                    sad: attr.emotion ? attr.emotion.sadness : '',
                    surprise: attr.emotion ? attr.emotion.surprise : '',
                    angry: attr.emotion ? attr.emotion.anger : '',
                    disgust: attr.emotion ? attr.emotion.disgust : '',
                    fear: attr.emotion ? attr.emotion.fear : ''
                },
                skin: {
                    health: attr.skinstatus ? attr.skinstatus.health : '',
                    spots: attr.skinstatus ? attr.skinstatus.stain : '',
                    dark_circles: attr.skinstatus ? attr.skinstatus.dark_circle : '',
                    acne: attr.skinstatus ? attr.skinstatus.acne : ''
                }
            };

            const userInfo = getUserInfo();
            const prompt = buildPrompt(faceInfo, userInfo);
            const resultText = await callGPT(prompt);
            displayRecommendations(resultText);
        }
    // æ‹ç…§åŠŸèƒ½
    // æ¸²æŸ“æ£€æµ‹ç»“æœï¼ˆé‡ç‚¹ä¿®æ”¹éƒ¨åˆ†ï¼‰
    function renderResults(data) {
            // å®šä¹‰æƒ…ç»ªå­—æ®µçš„ä¸­æ–‡æ˜ å°„
            const emotionLabels = {
                anger: 'æ„¤æ€’',
                disgust: 'åŒæ¶',
                fear: 'ææƒ§',
                happiness: 'é«˜å…´',
                neutral: 'å¹³é™',
                sadness: 'ä¼¤å¿ƒ',
                surprise: 'æƒŠè®¶'
            };
    
      // æ–°å¢çš®è‚¤çŠ¶æ€å­—æ®µçš„ä¸­æ–‡æ˜ å°„
      const skinstatusLabels = {
        health: 'å¥åº·',
        stain: 'è‰²æ–‘',
        acne: 'é’æ˜¥ç—˜',
        dark_circle: 'é»‘çœ¼åœˆ'
      };
    
      let html = '<h3>äººè„¸æ£€æµ‹ç»“æœ</h3>';
      if (data && data.faces && data.faces.length > 0) {
        data.faces.forEach((face, index) => {
          html += `
          <div class="result-item">äººè„¸${index + 1}ï¼š</div>
          <div class="result-item">æ€§åˆ«ï¼š${face.attributes.gender?.value || 'æœªçŸ¥'}</div>
          <div class="result-item">å¹´é¾„ï¼š${face.attributes.age?.value || 'æœªçŸ¥'}</div>
          ${face.attributes.beauty ? `
              <div class="result-item">é¢œå€¼è¯„åˆ†ï¼š</div>
              <div class="sub-result">ç”·æ€§è¯„åˆ†ï¼š${face.attributes.beauty.male_score.toFixed(3)}</div>
              <div class="sub-result">å¥³æ€§è¯„åˆ†ï¼š${face.attributes.beauty.female_score.toFixed(3)}</div>
          ` : ''}
          <div class="result-item">å¾®ç¬‘åº¦ï¼š${face.attributes.smile?.value ? face.attributes.smile.value.toFixed(2) : 'æœªçŸ¥'}%</div>
          `;
    
          // å¤„ç†emotionï¼ˆæƒ…ç»ªï¼‰
          if (face.attributes.emotion) {
            html += '<div class="result-item">æƒ…ç»ªåˆ†å¸ƒï¼š</div>';
            Object.entries(face.attributes.emotion).forEach(([key, value]) => {
              const label = emotionLabels[key] || key;
              // æ–°å¢ç±»å‹æ£€æŸ¥ï¼Œé¿å…undefinedè°ƒç”¨toFixed
              const safeValue = typeof value === 'number' ? value : 0;
              html += `<div class="sub-result">${label}ï¼š${safeValue.toFixed(3)}</div>`;
            });
          }
    
          // å¤„ç†skinstatusï¼ˆçš®è‚¤çŠ¶æ€ï¼‰
          if (face.attributes.skinstatus) {
            html += '<div class="result-item">çš®è‚¤çŠ¶æ€ï¼š</div>';
            Object.entries(face.attributes.skinstatus).forEach(([key, value]) => {
              const label = skinstatusLabels[key] || key;
              // æ–°å¢ç±»å‹æ£€æŸ¥ï¼Œé¿å…undefinedè°ƒç”¨toFixed
              const safeValue = typeof value === 'number' ? value : 0;
              html += `<div class="sub-result">${label}ï¼š${safeValue.toFixed(3)}</div>`;
            });
          }
        });
      } else {
        html += '<div class="result-item">æœªæ£€æµ‹åˆ°äººè„¸</div>';
      } // æ·»åŠ ç¼ºå¤±çš„é—­åˆå¤§æ‹¬å·
      
      faceResult.innerHTML = html;
      faceResult.style.display = 'block';
    }
    // æ‹ç…§é€»è¾‘
    captureBtn.addEventListener('click', async () => {
            if (!mediaStream) {
                await initCamera();
            } else {
                // ç”Ÿæˆå›¾ç‰‡Blob
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg');
                const response = await fetch(imageData);
                const imageBlob = await response.blob();

                // æ˜¾ç¤ºå›¾ç‰‡
                resultImage.src = imageData;
                resultImage.style.display = 'block';
                stopCamera();
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'inline-block';

                // è°ƒç”¨APIå¹¶è·å–æ¨è
                const detectData = await detectFaces(imageBlob);
                if (detectData) await processFaceData(detectData);

                }
        });
retakeBtn.addEventListener("click", () => {
    faceResult.style.display = "none";
    resultImage.style.display = "none";
    captureBtn.style.display = "inline-block";
    retakeBtn.style.display = "none";
    recommendationOutput.style.display = "none";
    initCamera();
});

  </script>
</body>
</html>


