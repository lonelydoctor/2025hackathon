<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>菜品推荐流程</title>
<style>
  body {
    margin: 0;
    font-family: Arial, 'Microsoft YaHei', sans-serif;
    min-height: 100vh;
    background: url('./images/dishes-2.jpeg') center/cover fixed;
    position: relative;
    color: #333;
  }
  body::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: inherit;
    filter: blur(8px) brightness(1.1);
    z-index: -1;
  }
  .page { display:none; padding:20px; text-align:center; }
  .page.active { display:block; }
  .camera-area {
    width:300px; height:300px; background:#fff; border-radius:24px;
    margin:1rem auto; overflow:hidden; position:relative;
  }
  #video { width:100%; height:100%; object-fit:cover; }
  #capture-canvas { display:none; }
  .header {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px; background:#f5f5e6; border-bottom:1px solid #ddd;
  }
  .header .title { font-weight:bold; }
  .icon-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; }

  /* swiper */
  .swiper { display:flex; width:300%; transition:transform 0.4s ease; }
  .slide { width:100%; box-sizing:border-box; padding:20px; }
  .result-container { display:flex; justify-content:center; align-items:center; gap:20px; flex-wrap:wrap; }
  #result-photo,#fortune-photo { max-width:150px; height:auto; border-radius:20px; object-fit:cover; }
  .info-panel { background:rgba(255,255,255,0.9); padding:1rem; border-radius:10px; text-align:left; min-width:200px; }
  .attr-table { width:100%; border-collapse:collapse; }
  .attr-table td { padding:4px 6px; border-bottom:1px solid #ccc; }
  .chart { margin-top:0.5rem; }
  .bar-row { display:flex; align-items:center; margin-bottom:6px; font-size:0.9rem; }
  .bar-label { width:60px; }
  .bar-container { flex:1; background:#eee; height:8px; border-radius:4px; margin:0 5px; }
  .bar { height:100%; background:#4CAF50; border-radius:4px; }
  .bar-value { width:30px; text-align:right; font-size:0.8rem; }
  #retry-btn { margin-top:20px; }

  .fortune-panel div { margin-bottom:6px; }
  .color-box { display:inline-block; width:20px; height:20px; border-radius:4px; vertical-align:middle; margin-right:6px; }

  .cards { display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; }
  .dish-card { background:#fff; border-radius:10px; width:150px; flex-shrink:0; }
  .dish-card img { width:100%; height:100px; object-fit:cover; border-radius:10px 10px 0 0; }
  .dish-card .dish-title { padding:6px; font-size:0.9rem; }
  .buttons { display:flex; justify-content:center; gap:10px; margin-top:20px; }
  .outline-btn { border:1px solid #8b4513; background:none; color:#8b4513; padding:8px 16px; border-radius:6px; cursor:pointer; }

  .pager { text-align:center; margin-top:10px; }
  .dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:#ccc; margin:0 3px; }
  .dot.active { background:#666; }
</style>
</head>
<body>
<div id="capture-page" class="page active">
  <h1>菜品推荐</h1>
  <div class="camera-area">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="capture-canvas"></canvas>
  </div>
  <button id="capture-btn">点击拍照</button>
</div>

<div id="result-page" class="page">
  <div class="header">
    <button id="back-btn" class="icon-btn">←</button>
    <span class="title">菜品推荐</span>
    <div>
      <button class="icon-btn">👤</button>
      <button class="icon-btn">🔗</button>
    </div>
  </div>
  <div id="swiper" class="swiper">
    <div class="slide" id="slide-analysis">
      <div class="result-container">
        <img id="result-photo" />
        <div id="analysis-results" class="info-panel"></div>
      </div>
      <button id="retry-btn">重试一次</button>
    </div>
    <div class="slide" id="slide-fortune">
      <div class="result-container">
        <img id="fortune-photo" />
        <div id="fortune-results" class="info-panel fortune-panel"></div>
      </div>
    </div>
    <div class="slide" id="slide-dish">
      <div class="cards" id="dish-cards"></div>
      <div class="buttons">
        <button class="outline-btn">我已选好，一键开吃</button>
        <button class="outline-btn">填写个人信息，推荐更精准</button>
      </div>
    </div>
  </div>
  <div class="pager">
    <span class="dot active"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  </div>
</div>

<script>
let mediaStream = null;
const capturePage = document.getElementById('capture-page');
const resultPage = document.getElementById('result-page');
const video = document.getElementById('video');
const canvas = document.getElementById('capture-canvas');
const captureBtn = document.getElementById('capture-btn');
const resultPhoto = document.getElementById('result-photo');
const fortunePhoto = document.getElementById('fortune-photo');
const analysisResults = document.getElementById('analysis-results');
const fortuneResults = document.getElementById('fortune-results');
const dishCards = document.getElementById('dish-cards');
const retryBtn = document.getElementById('retry-btn');
const backBtn = document.getElementById('back-btn');
const swiper = document.getElementById('swiper');
const dots = document.querySelectorAll('.dot');
let currentSlide = 0;
let photoData = '';
let latestFaceInfo = null;

function showPage(p){ capturePage.classList.remove('active'); resultPage.classList.remove('active'); p.classList.add('active'); }

async function initCamera(){
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    video.srcObject = mediaStream;
    await video.play();
  }catch(e){
    alert('无法访问摄像头');
  }
}

function stopCamera(){
  if(mediaStream){
    mediaStream.getTracks().forEach(t=>t.stop());
    mediaStream = null;
  }
}

function showSlide(i){
  currentSlide = Math.max(0, Math.min(i, 2));
  swiper.style.transform = `translateX(-${currentSlide*100}%)`;
  dots.forEach((d,idx)=>d.classList.toggle('active', idx===currentSlide));
}

let startX=0;
swiper.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;});
swiper.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-startX;
  if(dx>50) showSlide(currentSlide-1); else if(dx<-50) showSlide(currentSlide+1);
});

dots.forEach((dot,idx)=>dot.addEventListener('click',()=>showSlide(idx)));

captureBtn.onclick = async () => {
  if(!mediaStream) await initCamera();
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  photoData = canvas.toDataURL('image/jpeg');
  stopCamera();
  resultPhoto.src = photoData;
  fortunePhoto.src = photoData;
  const blob = await (await fetch(photoData)).blob();
  const detect = await detectFaces(blob);
  renderFace(detect);
  const text = await callGPT(buildPrompt(latestFaceInfo,{}));
  if(text){
    try{ const obj = JSON.parse(text); renderFortune(obj.metaphysics||{}); renderDishes(obj.recommendations||[]); }catch(e){ fortuneResults.textContent = text; }
  }
  showPage(resultPage);
  showSlide(0);
};

retryBtn.onclick = () => { showPage(capturePage); initCamera(); };
backBtn.onclick = () => { showPage(capturePage); initCamera(); };

async function detectFaces(imageBlob){
  const formData = new FormData();
  formData.append('api_key','mSptsjK7hxWAuKyOGmTjQAhYwJ2MaCJJ');
  formData.append('api_secret','vcBaU1AknR9S_NgPnc8oZGrEn-H-_NOk');
  formData.append('image_file',imageBlob,'photo.jpg');
  formData.append('return_attributes','gender,age,smiling,emotion,skinstatus');
  const resp = await fetch('https://api-cn.faceplusplus.com/facepp/v3/detect',{method:'POST',body:formData});
  const data = await resp.json();
  if(data.faces && data.faces.length){
    const attr = data.faces[0].attributes;
    latestFaceInfo = {gender:attr.gender.value, age:attr.age.value, smile:attr.smile.value, emotion:attr.emotion, skin:attr.skinstatus};
  }
  return data;
}

const EMOTION_MAP = {anger:'愤怒', disgust:'厌恶', fear:'恐惧', happiness:'高兴', neutral:'平静', sadness:'伤心', surprise:'惊讶'};
const SKIN_MAP = {health:'健康', stain:'色斑', dark_circle:'黑眼圈', acne:'青春痘'};

function barRows(obj,map={}){
  let html='';
  for(const k in obj){
    const v=obj[k];
    const label=map[k]||k;
    html += `<div class="bar-row"><span class="bar-label">${label}</span><div class="bar-container"><div class="bar" style="width:${v}%"></div></div><span class="bar-value">${v.toFixed(1)}</span></div>`;
  }
  return html;
}

function renderFace(data){
  if(!data || !data.faces || !data.faces.length){ analysisResults.textContent='未检测到人脸'; return; }
  const a=data.faces[0].attributes;
  let html='<table class="attr-table">';
  html+=`<tr><td>性别</td><td>${a.gender.value}</td></tr>`;
  html+=`<tr><td>年龄</td><td>${a.age.value}</td></tr>`;
  html+=`<tr><td>微笑度</td><td>${a.smile.value.toFixed(2)}%</td></tr>`;
  html+='</table>';
  if(a.emotion) html+=`<div class="chart"><h3>情绪分布</h3>${barRows(a.emotion,EMOTION_MAP)}</div>`;
  if(a.skinstatus) html+=`<div class="chart"><h3>皮肤状态</h3>${barRows(a.skinstatus,SKIN_MAP)}</div>`;
  analysisResults.innerHTML=html;
}

function renderFortune(meta){
  let html='';
  if(meta.lucky_color){ html+=`<div>幸运色：<span class="color-box" style="background:${meta.lucky_color}"></span>${meta.lucky_color}</div>`; }
  if(meta.guardian_star) html+=`<div>守护星：${meta.guardian_star}</div>`;
  if(meta.five_elements_food) html+=`<div>五行调和：${meta.five_elements_food}</div>`;
  if(meta.today_yi) html+=`<div>宜：${meta.today_yi}</div>`;
  if(meta.today_ji) html+=`<div>忌：${meta.today_ji}</div>`;
  if(meta.lucky_number) html+=`<div>幸运数字：${meta.lucky_number}</div>`;
  html+=`<div>日期：${new Date().toLocaleDateString()}</div>`;
  fortuneResults.innerHTML=html;
}

function renderDishes(list){
  const titles=['幸运色推荐','面部状态调理','情绪调理','节气特色食材'];
  dishCards.innerHTML='';
  list.slice(0,4).forEach((d,i)=>{
    const card=document.createElement('div');
    card.className='dish-card';
    const img=document.createElement('img');
    img.src='./images/dishes.jpeg';
    const title=document.createElement('div');
    title.className='dish-title';
    title.textContent=`${titles[i]||''} - ${d.dish||''}`;
    card.appendChild(img); card.appendChild(title);
    dishCards.appendChild(card);
  });
}

const PROMPT_TEMPLATE = `你是「AI面相玄学营养推荐师」，根据用户面部信息生成食疗推荐。\n[FACE]\n`;
function buildPrompt(face,user){ return PROMPT_TEMPLATE.replace('[FACE]',JSON.stringify(face)); }
const DASHSCOPE_API_KEY = 'YOUR_DASHSCOPE_API_KEY';
async function callGPT(prompt){
  const resp = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{
    method:'POST',
    headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+DASHSCOPE_API_KEY },
    body:JSON.stringify({ model:'deepseek-r1', messages:[{role:'user',content:prompt}] })
  });
  const data = await resp.json();
  return data.choices && data.choices[0].message.content;
}
</script>
</body>
</html>
