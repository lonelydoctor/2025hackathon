<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>菜品推荐流程</title>
<style>
  body {
    margin: 0;
    font-family: Arial, 'Microsoft YaHei', sans-serif;
    min-height: 100vh;
    background: url('./images/dishes-2.jpeg') center/cover fixed;
    position: relative;
    color: #333;
  }
  body::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: inherit;
    filter: blur(8px) brightness(1.1);
    z-index: -1;
  }
  .page { display:none; padding:20px; text-align:center; }
  .page.active { display:block; }
  .camera-area {
    width:300px; height:300px; background:#fff; border-radius:24px;
    margin:1rem auto; overflow:hidden; position:relative;
  }
  #video { width:100%; height:100%; object-fit:cover; }
  #capture-canvas { display:none; }
  .header {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px; background:#f5f5e6; border-bottom:1px solid #ddd;
  }
  .header .title { font-weight:bold; }
  .icon-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; }

  /* swiper */
  .swiper { display:flex; width:300%; transition:transform 0.4s ease; }
  .slide { width:100%; box-sizing:border-box; padding:20px; }
  .result-container { display:flex; justify-content:center; align-items:center; gap:20px; flex-wrap:nowrap; }
  #result-photo,#fortune-photo {
    width:200px;
    height:200px;
    border-radius:20px;
    object-fit:cover;
  }
  .info-panel { background:rgba(255,255,255,0.9); padding:1rem; border-radius:10px; text-align:left; min-width:200px; }
  .attr-table { width:100%; border-collapse:collapse; }
  .attr-table td { padding:4px 6px; border-bottom:1px solid #ccc; }
  .chart { margin-top:0.5rem; }
  .bar-row { display:flex; align-items:center; margin-bottom:6px; font-size:0.9rem; }
  .bar-label { width:60px; }
  .bar-container { flex:1; background:#eee; height:8px; border-radius:4px; margin:0 5px; }
  .bar { height:100%; background:#4CAF50; border-radius:4px; }
  .bar-value { width:30px; text-align:right; font-size:0.8rem; }
  #retry-btn { margin-top:20px; }

  .fortune-panel div { margin-bottom:6px; }
  .color-box { display:inline-block; width:20px; height:20px; border-radius:4px; vertical-align:middle; margin-right:6px; }

  .cards { display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; }
  .dish-card { background:#fff; border-radius:10px; width:150px; flex-shrink:0; }
  .dish-card img { width:100%; height:100px; object-fit:cover; border-radius:10px 10px 0 0; }
  .dish-card .dish-title { padding:6px; font-size:0.9rem; }
  .buttons { display:flex; justify-content:center; gap:10px; margin-top:20px; }
  .outline-btn { border:1px solid #8b4513; background:none; color:#8b4513; padding:8px 16px; border-radius:6px; cursor:pointer; }

  .pager { text-align:center; margin-top:10px; }
  .dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:#ccc; margin:0 3px; }
  .dot.active { background:#666; }
</style>
</head>
<body>
<div id="capture-page" class="page active">
  <h1>菜品推荐</h1>
  <div class="camera-area">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="capture-canvas"></canvas>
  </div>
  <button id="capture-btn">点击拍照</button>
</div>

<div id="result-page" class="page">
  <div class="header">
    <button id="back-btn" class="icon-btn">←</button>
    <span class="title">菜品推荐</span>
    <div>
      <button class="icon-btn">👤</button>
      <button class="icon-btn">🔗</button>
    </div>
  </div>
  <div id="swiper" class="swiper">
    <div class="slide" id="slide-analysis">
      <div class="result-container">
        <img id="result-photo" />
        <div id="analysis-results" class="info-panel"></div>
      </div>
      <button id="retry-btn">重试一次</button>
    </div>
    <div class="slide" id="slide-fortune">
      <div class="result-container">
        <img id="fortune-photo" />
        <div id="fortune-results" class="info-panel fortune-panel"></div>
      </div>
    </div>
    <div class="slide" id="slide-dish">
      <div class="cards" id="dish-cards"></div>
      <div class="buttons">
        <button class="outline-btn">我已选好，一键开吃</button>
        <button class="outline-btn">填写个人信息，推荐更精准</button>
      </div>
    </div>
  </div>
  <div class="pager">
    <span class="dot active"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  </div>
</div>

<script>
let mediaStream = null;
const capturePage = document.getElementById('capture-page');
const resultPage = document.getElementById('result-page');
const video = document.getElementById('video');
const canvas = document.getElementById('capture-canvas');
const captureBtn = document.getElementById('capture-btn');
const resultPhoto = document.getElementById('result-photo');
const fortunePhoto = document.getElementById('fortune-photo');
const analysisResults = document.getElementById('analysis-results');
const fortuneResults = document.getElementById('fortune-results');
const dishCards = document.getElementById('dish-cards');
const retryBtn = document.getElementById('retry-btn');
const backBtn = document.getElementById('back-btn');
const swiper = document.getElementById('swiper');
const dots = document.querySelectorAll('.dot');
let currentSlide = 0;
let photoData = '';
let latestFaceInfo = null;

function showPage(p){ capturePage.classList.remove('active'); resultPage.classList.remove('active'); p.classList.add('active'); }

async function initCamera(){
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    video.srcObject = mediaStream;
    await video.play();
  }catch(e){
    alert('无法访问摄像头');
  }
}

function stopCamera(){
  if(mediaStream){
    mediaStream.getTracks().forEach(t=>t.stop());
    mediaStream = null;
    video.srcObject = null;
  }
}

function showSlide(i){
  currentSlide = Math.max(0, Math.min(i, 2));
  swiper.style.transform = `translateX(-${currentSlide*100}%)`;
  dots.forEach((d,idx)=>d.classList.toggle('active', idx===currentSlide));
}

let startX=0;
swiper.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;});
swiper.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-startX;
  if(dx>50) showSlide(currentSlide-1); else if(dx<-50) showSlide(currentSlide+1);
});

dots.forEach((dot,idx)=>dot.addEventListener('click',()=>showSlide(idx)));

captureBtn.onclick = async () => {
  if(!mediaStream) await initCamera();
  if(video.readyState < 2){
    await new Promise(r => video.onloadedmetadata = () => r());
  }
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  photoData = canvas.toDataURL('image/jpeg');
  stopCamera();
  resultPhoto.src = photoData;
  fortunePhoto.src = photoData;
  showPage(resultPage);
  showSlide(0);
  const blob = await (await fetch(photoData)).blob();
  const detect = await detectFaces(blob);
  renderFace(detect);
  const text = await callGPT(buildPrompt(latestFaceInfo,{}));
  if(text){
    try{
      const obj = JSON.parse(text);
      renderFortune(obj.metaphysics||{}, obj.face_summary, obj.mood_summary);
      renderDishes(obj.recommendations||[]);
    }catch(e){
      fortuneResults.textContent = text;
    }
  }
};

retryBtn.onclick = () => { showPage(capturePage); initCamera(); };
backBtn.onclick = () => { showPage(capturePage); initCamera(); };

async function detectFaces(imageBlob){
  const formData = new FormData();
  formData.append('api_key','mSptsjK7hxWAuKyOGmTjQAhYwJ2MaCJJ');
  formData.append('api_secret','vcBaU1AknR9S_NgPnc8oZGrEn-H-_NOk');
  formData.append('image_file',imageBlob,'photo.jpg');
  formData.append('return_attributes','gender,age,smiling,emotion,skinstatus');
  const resp = await fetch('https://api-cn.faceplusplus.com/facepp/v3/detect',{
    method:'POST',
    body:formData
  });
  const data = await resp.json();
  if(data.faces && data.faces.length){
    const attr = data.faces[0].attributes;
    latestFaceInfo = {gender:attr.gender.value, age:attr.age.value, smile:attr.smile.value, emotion:attr.emotion, skin:attr.skinstatus};
  }
  return data;
}

const EMOTION_MAP = {anger:'愤怒', disgust:'厌恶', fear:'恐惧', happiness:'高兴', neutral:'平静', sadness:'伤心', surprise:'惊讶'};
const SKIN_MAP = {health:'健康', stain:'色斑', dark_circle:'黑眼圈', acne:'青春痘'};

function barRows(obj,map={}){
  let html='';
  for(const k in obj){
    const v=obj[k];
    const label=map[k]||k;
    html += `<div class="bar-row"><span class="bar-label">${label}</span><div class="bar-container"><div class="bar" style="width:${v}%"></div></div><span class="bar-value">${v.toFixed(1)}</span></div>`;
  }
  return html;
}

function renderFace(data){
  if(!data || !data.faces || !data.faces.length){ analysisResults.textContent='未检测到人脸'; return; }
  const a=data.faces[0].attributes;
  let html='<table class="attr-table">';
  html+=`<tr><td>性别</td><td>${a.gender.value}</td></tr>`;
  html+=`<tr><td>年龄</td><td>${a.age.value}</td></tr>`;
  html+=`<tr><td>微笑度</td><td>${a.smile.value.toFixed(2)}%</td></tr>`;
  html+='</table>';
  if(a.emotion) html+=`<div class="chart"><h3>情绪分布</h3>${barRows(a.emotion,EMOTION_MAP)}</div>`;
  if(a.skinstatus) html+=`<div class="chart"><h3>皮肤状态</h3>${barRows(a.skinstatus,SKIN_MAP)}</div>`;
  analysisResults.innerHTML=html;
}

function renderFortune(meta, faceSummary='', moodSummary=''){
  let html='';
  if(meta.lucky_color){ html+=`<div>幸运色：<span class="color-box" style="background:${meta.lucky_color}"></span>${meta.lucky_color}</div>`; }
  if(meta.guardian_star) html+=`<div>守护星：${meta.guardian_star}</div>`;
  if(meta.five_elements_food) html+=`<div>五行调和：${meta.five_elements_food}</div>`;
  if(meta.today_yi) html+=`<div>宜：${meta.today_yi}</div>`;
  if(meta.today_ji) html+=`<div>忌：${meta.today_ji}</div>`;
  if(meta.lucky_number) html+=`<div>幸运数字：${meta.lucky_number}</div>`;
  html+=`<div>日期：${new Date().toLocaleDateString()}</div>`;
  if(faceSummary) html+=`<div>${faceSummary}</div>`;
  if(moodSummary) html+=`<div>${moodSummary}</div>`;
  fortuneResults.innerHTML=html;
}

function renderDishes(list){
  const titles=['幸运色推荐','面部状态调理','情绪调理','节气特色食材'];
  dishCards.innerHTML='';
  list.slice(0,4).forEach((d,i)=>{
    const card=document.createElement('div');
    card.className='dish-card';
    const img=document.createElement('img');
    img.src='./images/dishes.jpeg';
    const title=document.createElement('div');
    title.className='dish-title';
    title.textContent=`${titles[i]||''} - ${d.dish||''}`;
    card.appendChild(img); card.appendChild(title);
    dishCards.appendChild(card);
  });
}

const PROMPT_TEMPLATE = `你是「AI面相玄学营养推荐师」，融合面部识别结果、用户填写问卷信息、现代营养科学与东方玄学，为C端用户生成趣味、精准、个性化的午餐推荐建议。

你的任务：
- 输入数据：面部识别数据（必填）+ 用户问卷信息（选填）
- 输出严格结构化的JSON格式，供前端系统解析展示；
- 内容逻辑结合面部图像分析与用户个性化填写信息；
- 保持创造性表达，避免模板重复，确保每日输出有新鲜感、社交传播性和娱乐体验。
---

【输入数据】

### 必填输入（面部识别接口提供，始终存在）
[FACE_JSON]

选填输入（用户问卷信息，部分或全部可能缺省）
[USER_JSON]

你需要结合必填的面部识别结果，与选填的用户信息问卷，整合生成饮食推荐结果。选填问卷信息如果缺失，可仅基于面部识别数据独立完成生成；原则如下：

填写的信息越多，内容应体现越丰富个性化；

逻辑丰富，但输出需灵活多样，不得固定模板死板输出；

保留充分创造空间，体现AI的创造力与娱乐性。

一、各字段生成说明
1. metaphysics（玄学信息）
lucky_color：综合面部状态、情绪表现、近期关注方向、血型等自由发挥，参考五行色系（金白银、木青绿、水黑蓝、火红橙紫、土黄棕）。
lucky_number：结合年龄、情绪、健康目标、玄学诉求等生成有积极寓意的幸运数字（1-9）。
guardian_star：结合生日、血型、玄学诉求，自由设定东方玄学或趣味守护星（如：紫微、文昌、天喜、福德、招财猫等）。
five_elements_food：生成今日宜食五行搭配描述（如：水木双修 清火养颜）。
today_yi / today_ji：饮食与情绪上的宜忌提示，语言可幽默轻松。

2. face_summary（面相玄学解读）
融合面部皮肤指标、微笑度、气场生成趣味面相解读语。

3. mood_summary（心情解读）
综合面部情绪与自填今日心情自由生成，语言亲切轻松。

4. recommendations（菜品推荐）
每次输出 4 道菜品，每道菜品包含：

dish：具体菜品名称；
fun_comment：轻松幽默俏皮的趣味文案，可押韵可加emoji；
metaphysics_reason：玄学背书逻辑；
nutrition_value：通俗营养亮点；
seasonal_reason：节气或时令合理性。

菜品逻辑分布：
第一菜：幸运色呼应食材；
第二菜：面部皮肤调理食材；
第三菜：健康目标&情绪疗愈食材；
第四菜：节气时令食材。

需注意：
食材需符合用户忌口限制；
充分体现健康目标（如减脂→控油高蛋白，增肌→补蛋白，护胃→软烂清淡）；
结合活动量与当前能量代谢需求匹配推荐。

5. personalized_insight（个人专属锦囊）
health_tip：个性化健康建议；
energy_tip：气场能量提醒；
fortune_tip：运势玄学锦囊。

6️. closing_quote（结尾祝福）
一句适合社交分享的轻松结语。

【特别提醒】
除 JSON 结构之外严禁输出任何多余文字；
保证输出内容每日有新鲜感，避免模板套路式结果；
风格整体保持年轻化、趣味玄学、正能量、社交传播感极强。

【输出格式要求】
请严格按照如下结构化JSON格式输出，字段顺序、层级、命名必须一致。除JSON之外不得输出任何其他文字。

{
  "metaphysics": {
    "lucky_color": "",
    "lucky_number": "",
    "guardian_star": "",
    "five_elements_food": "",
    "today_yi": "",
    "today_ji": ""
  },
  "face_summary": "",
  "mood_summary": "",
  "recommendations": [
    {
      "dish": "",
      "fun_comment": "",
      "metaphysics_reason": "",
      "nutrition_value": "",
      "seasonal_reason": ""
    },
    {
      "dish": "",
      "fun_comment": "",
      "metaphysics_reason": "",
      "nutrition_value": "",
      "seasonal_reason": ""
    },
    {
      "dish": "",
      "fun_comment": "",
      "metaphysics_reason": "",
      "nutrition_value": "",
      "seasonal_reason": ""
    },
    {
      "dish": "",
      "fun_comment": "",
      "metaphysics_reason": "",
      "nutrition_value": "",
      "seasonal_reason": ""
    }
  ],
  "personalized_insight": {
    "health_tip": "",
    "energy_tip": "",
    "fortune_tip": ""
  },
  "closing_quote": "",
  "disclaimer": "AI食疗建议，仅供娱乐参考"
}`;

function buildPrompt(face,user){
  return PROMPT_TEMPLATE.replace('[FACE_JSON]', JSON.stringify(face))
                        .replace('[USER_JSON]', JSON.stringify(user||{}));
}
const DASHSCOPE_API_KEY = 'sk-2487917f84dd4a948891b51a22a0832e';
async function callGPT(prompt){
  const resp = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{
    method:'POST',
    headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+DASHSCOPE_API_KEY },
    body:JSON.stringify({ model:'deepseek-r1', messages:[{role:'user',content:prompt}] })
  });
  const data = await resp.json();
  return data.choices && data.choices[0].message.content;
}

document.addEventListener('DOMContentLoaded', () => {
  initCamera();
});
</script>
</body>
</html>
