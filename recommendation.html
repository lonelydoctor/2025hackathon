<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èœå“æ¨èæµç¨‹</title>
<style>
  body {
    margin: 0;
    font-family: Arial, 'Microsoft YaHei', sans-serif;
    min-height: 100vh;
    background: url('./images/dishes-2.jpeg') center/cover fixed;
    position: relative;
    color: #333;
  }
  body::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: inherit;
    filter: blur(8px) brightness(1.1);
    z-index: -1;
  }
  .page { display:none; padding:20px; text-align:center; }
  .page.active { display:block; }
  .camera-area {
    width:300px; height:300px; background:#fff; border-radius:24px;
    margin:1rem auto; overflow:hidden; position:relative;
  }
  #video { width:100%; height:100%; object-fit:cover; }
  #capture-canvas { display:none; }
  .header {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px; background:#f5f5e6;
    border-bottom:none;
  }
  h1 { border-bottom:none; }
  .header .title {
    font-weight:bold;
    font-size:2rem;
  }
  .icon-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; }

  /* swiper */
  .swiper { display:flex; width:300vw; transition:transform 0.4s ease; }
  .slide { width:100vw; box-sizing:border-box; padding:20px; }
  .result-container { display:flex; justify-content:center; align-items:center; gap:20px; flex-wrap:nowrap; }
  #result-photo,#fortune-photo {
    width:260px;
    height:260px;
    border-radius:20px;
    object-fit:cover;
  }
  .info-panel { background:rgba(255,255,255,0.9); padding:1rem; border-radius:10px; text-align:left; min-width:200px; }
  .attr-table { width:100%; border-collapse:collapse; }
  .attr-table td { padding:4px 6px; border-bottom:1px solid #ccc; }
  .chart { margin-top:0.5rem; }
  .bar-row { display:flex; align-items:center; margin-bottom:6px; font-size:0.9rem; }
  .bar-label { width:60px; }
  .bar-container { flex:1; background:#eee; height:8px; border-radius:4px; margin:0 5px; }
  .bar { height:100%; background:#4CAF50; border-radius:4px; }
  .bar-value { width:30px; text-align:right; font-size:0.8rem; }
  #retry-btn { margin-top:20px; }

  .fortune-panel div { margin-bottom:6px; }
  .color-box { display:inline-block; width:20px; height:20px; border-radius:4px; vertical-align:middle; margin-right:6px; }

  .cards { display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; }
  .dish-card { background:#fff; border-radius:10px; width:150px; flex-shrink:0; }
  .dish-card img { width:100%; height:100px; object-fit:cover; border-radius:10px 10px 0 0; }
  .dish-card .dish-category { padding:4px; font-size:0.8rem; font-weight:bold; }
  .dish-card .dish-title { padding:6px; font-size:0.9rem; }
  .buttons { display:flex; justify-content:center; gap:10px; margin-top:20px; }
  .outline-btn { border:1px solid #8b4513; background:none; color:#8b4513; padding:8px 16px; border-radius:6px; cursor:pointer; }

  .pager { text-align:center; margin-top:10px; }
  .dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:#ccc; margin:0 3px; }
  .dot.active { background:#666; }
</style>
</head>
<body>
<div id="capture-page" class="page active">
  <h1>èœå“æ¨è</h1>
  <div class="camera-area">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="capture-canvas"></canvas>
  </div>
  <button id="capture-btn">ç‚¹å‡»æ‹ç…§</button>
</div>

<div id="result-page" class="page">
  <div class="header">
    <button id="back-btn" class="icon-btn">â†</button>
    <span class="title">èœå“æ¨è</span>
    <div>
      <button class="icon-btn">ğŸ‘¤</button>
      <button class="icon-btn">ğŸ”—</button>
    </div>
  </div>
  <div id="swiper" class="swiper">
    <div class="slide" id="slide-analysis">
      <div class="result-container">
        <img id="result-photo" />
        <div id="analysis-results" class="info-panel"></div>
      </div>
      <button id="retry-btn">é‡è¯•ä¸€æ¬¡</button>
    </div>
    <div class="slide" id="slide-fortune">
      <div class="result-container">
        <img id="fortune-photo" />
        <div id="fortune-results" class="info-panel fortune-panel"></div>
      </div>
    </div>
    <div class="slide" id="slide-dish">
      <div class="cards" id="dish-cards"></div>
      <div class="buttons">
        <button class="outline-btn">æˆ‘å·²é€‰å¥½ï¼Œä¸€é”®å¼€åƒ</button>
        <button class="outline-btn">å¡«å†™ä¸ªäººä¿¡æ¯ï¼Œæ¨èæ›´ç²¾å‡†</button>
      </div>
    </div>
  </div>
  <div class="pager">
    <span class="dot active"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  </div>
</div>

<script>
let mediaStream = null;
const capturePage = document.getElementById('capture-page');
const resultPage = document.getElementById('result-page');
const video = document.getElementById('video');
const canvas = document.getElementById('capture-canvas');
const captureBtn = document.getElementById('capture-btn');
const resultPhoto = document.getElementById('result-photo');
const fortunePhoto = document.getElementById('fortune-photo');
const analysisResults = document.getElementById('analysis-results');
const fortuneResults = document.getElementById('fortune-results');
const dishCards = document.getElementById('dish-cards');
const retryBtn = document.getElementById('retry-btn');
const backBtn = document.getElementById('back-btn');
const swiper = document.getElementById('swiper');
const dots = document.querySelectorAll('.dot');
let currentSlide = 0;
let photoData = '';
let latestFaceInfo = null;

function showPage(p){ capturePage.classList.remove('active'); resultPage.classList.remove('active'); p.classList.add('active'); }

async function initCamera(){
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    video.srcObject = mediaStream;
    await video.play();
  }catch(e){
    alert('æ— æ³•è®¿é—®æ‘„åƒå¤´');
  }
}

function stopCamera(){
  if(mediaStream){
    mediaStream.getTracks().forEach(t=>t.stop());
    mediaStream = null;
    video.srcObject = null;
  }
}

function showSlide(i){
  currentSlide = Math.max(0, Math.min(i, 2));
  swiper.style.transform = `translateX(-${currentSlide*100}%)`;
  dots.forEach((d,idx)=>d.classList.toggle('active', idx===currentSlide));
}

let startX=0;
swiper.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;});
swiper.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-startX;
  if(dx>50) showSlide(currentSlide-1); else if(dx<-50) showSlide(currentSlide+1);
});

dots.forEach((dot,idx)=>dot.addEventListener('click',()=>showSlide(idx)));

captureBtn.onclick = async () => {
  if(!mediaStream) await initCamera();
  if(video.readyState < 2){
    await new Promise(r => video.onloadedmetadata = () => r());
  }
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  photoData = canvas.toDataURL('image/jpeg');
  stopCamera();
  resultPhoto.src = photoData;
  fortunePhoto.src = photoData;
  showPage(resultPage);
  showSlide(0);
  const blob = await (await fetch(photoData)).blob();
  const detect = await detectFaces(blob);
  renderFace(detect);
  renderFortuneStatic();
  renderDishesStatic();
};

retryBtn.onclick = () => { showPage(capturePage); initCamera(); };
backBtn.onclick = () => { showPage(capturePage); initCamera(); };

async function detectFaces(imageBlob){
  const formData = new FormData();
  formData.append('api_key','mSptsjK7hxWAuKyOGmTjQAhYwJ2MaCJJ');
  formData.append('api_secret','vcBaU1AknR9S_NgPnc8oZGrEn-H-_NOk');
  formData.append('image_file',imageBlob,'photo.jpg');
  formData.append('return_attributes','gender,age,smiling,emotion,skinstatus');
  const resp = await fetch('https://api-cn.faceplusplus.com/facepp/v3/detect',{
    method:'POST',
    body:formData
  });
  const data = await resp.json();
  if(data.faces && data.faces.length){
    const attr = data.faces[0].attributes;
    latestFaceInfo = {gender:attr.gender.value, age:attr.age.value, smile:attr.smile.value, emotion:attr.emotion, skin:attr.skinstatus};
  }
  return data;
}

const EMOTION_MAP = {anger:'æ„¤æ€’', disgust:'åŒæ¶', fear:'ææƒ§', happiness:'é«˜å…´', neutral:'å¹³é™', sadness:'ä¼¤å¿ƒ', surprise:'æƒŠè®¶'};
const SKIN_MAP = {health:'å¥åº·', stain:'è‰²æ–‘', dark_circle:'é»‘çœ¼åœˆ', acne:'é’æ˜¥ç—˜'};

function barRows(obj,map={}){
  let html='';
  for(const k in obj){
    const v=obj[k];
    const label=map[k]||k;
    html += `<div class="bar-row"><span class="bar-label">${label}</span><div class="bar-container"><div class="bar" style="width:${v}%"></div></div><span class="bar-value">${v.toFixed(1)}</span></div>`;
  }
  return html;
}

function renderFace(data){
  if(!data || !data.faces || !data.faces.length){ analysisResults.textContent='æœªæ£€æµ‹åˆ°äººè„¸'; return; }
  const a=data.faces[0].attributes;
  let html='<table class="attr-table">';
  html+=`<tr><td>æ€§åˆ«</td><td>${a.gender.value}</td></tr>`;
  html+=`<tr><td>å¹´é¾„</td><td>${a.age.value}</td></tr>`;
  html+=`<tr><td>å¾®ç¬‘åº¦</td><td>${a.smile.value.toFixed(2)}%</td></tr>`;
  html+='</table>';
  if(a.emotion) html+=`<div class="chart"><h3>æƒ…ç»ªåˆ†å¸ƒ</h3>${barRows(a.emotion,EMOTION_MAP)}</div>`;
  if(a.skinstatus) html+=`<div class="chart"><h3>çš®è‚¤çŠ¶æ€</h3>${barRows(a.skinstatus,SKIN_MAP)}</div>`;
  analysisResults.innerHTML=html;
}

function renderFortuneStatic(){
  fortuneResults.innerHTML = `
    <div>å¹¸è¿è‰²ï¼š<span class="color-box" style="background:green"></span><span style="color:green">ç»¿è‰²</span></div>
    <div>å®ˆæŠ¤æ˜Ÿï¼šå¤©å–œæ˜Ÿ</div>
    <div>äº”è¡Œè°ƒå’Œï¼šæœ¨ç«è°ƒå’Œ å…»è‚æ¸…ç«</div>
    <div>å®œï¼šå¤šæ‘„ç»¿å¶è”¬èœï¼Œæ»‹å…»æ°”è‰²ï¼Œå¤šç¬‘å¤šå¸å¥½è¿æ°”</div>
    <div>å¿Œï¼šå¿Œè¾›è¾£æ²¹ç‚¸ï¼Œé˜²ç«æ°”ä¸Šå‡ç”Ÿç—˜ç—˜</div>
    <div>å¹¸è¿æ•°å­—ï¼š3</div>
    <div>æ—¥æœŸï¼š6/20</div>`;
}

function renderDishesStatic(){
  // è‹¥æƒ³æ›¿æ¢èœå“å›¾ç‰‡ï¼Œå¯åœ¨ä¸‹æ–¹åˆ—è¡¨ä¸­ä¿®æ”¹ img å­—æ®µçš„è·¯å¾„
  const list = [
    {category:'å¹¸è¿è‰²æ¨è', dish:'è’œè“‰ç‚’è èœ', img:'./images/dishes.jpeg'},
    {category:'é¢éƒ¨çŠ¶æ€è°ƒç†', dish:'å†¬ç“œè–ç±³æ’éª¨æ±¤', img:'./images/dishes.jpeg'},
    {category:'æƒ…ç»ªè°ƒç†', dish:'ç™¾åˆé“¶è€³è²å­ç¾¹', img:'./images/dishes.jpeg'},
    {category:'èŠ‚æ°”ç‰¹è‰²é£Ÿæ', dish:'å‡‰æ‹Œè‹¦ç“œæœ¨è€³', img:'./images/dishes.jpeg'}
  ];
  dishCards.innerHTML='';
  list.forEach(item=>{
    const card=document.createElement('div');
    card.className='dish-card';
    const img=document.createElement('img');
    // å¦‚éœ€æ›´æ¢èœå“å›¾ç‰‡ï¼Œåœ¨åˆ—è¡¨ä¸­ä¿®æ”¹å¯¹åº”é¡¹çš„ img å­—æ®µ
    img.src = item.img;
    const cat=document.createElement('div');
    cat.className='dish-category';
    cat.textContent=item.category;
    const title=document.createElement('div');
    title.className='dish-title';
    title.textContent=item.dish;
    card.appendChild(img);
    card.appendChild(cat);
    card.appendChild(title);
    dishCards.appendChild(card);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  initCamera();
});
</script>
</body>
</html>
